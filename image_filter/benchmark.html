<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM vs JS Performance Benchmarks</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .benchmark-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.5em;
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .benchmark-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .benchmark-card {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .benchmark-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .benchmark-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .benchmark-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s;
        }

        button:hover {
            background: #764ba2;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .results {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-left: 4px solid #667eea;
            border-radius: 4px;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .result-row label {
            font-weight: 500;
            color: #333;
        }

        .result-row .value {
            color: #667eea;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .result-row.loading .value {
            color: #ff9800;
            font-style: italic;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
        }

        .comparison-table thead {
            background: #667eea;
            color: white;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .comparison-table tr:hover {
            background: #f5f5f5;
        }

        .comparison-table tr:last-child td {
            border-bottom: none;
        }

        .faster {
            color: #4caf50;
            font-weight: 600;
        }

        .slower {
            color: #f44336;
            font-weight: 600;
        }

        .summary {
            margin-top: 30px;
            padding: 20px;
            background: #e3f2fd;
            border-left: 4px solid #667eea;
            border-radius: 4px;
        }

        .summary h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-box {
            background: white;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .stat-value {
            color: #667eea;
            font-size: 1.5em;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        canvas {
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .loading-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .visualization-section {
            margin-top: 40px;
            padding: 30px;
            background: #f0f4ff;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .visualization-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-top: 20px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .performance-legend {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            justify-content: center;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }

        .legend-label {
            font-size: 0.9em;
            color: #666;
        }

        .controls-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .controls-bar button {
            padding: 8px 16px;
            font-size: 0.85em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #ddd;
        }

        .metric-title {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #667eea;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ WASM vs JavaScript Performance Benchmarks</h1>

        <div class="benchmark-section">
            <div class="section-title">Complex Math Operations</div>
            <div class="benchmark-grid">
                <div class="benchmark-card">
                    <h3>Mandelbrot Set (512x512, 100 iterations)</h3>
                    <div class="benchmark-controls">
                        <button onclick="runBenchmark('mandelbrot-js')">Run JS</button>
                        <button onclick="runBenchmark('mandelbrot-wasm')">Run WASM</button>
                    </div>
                    <div class="results">
                        <div class="result-row">
                            <label>JS Time:</label>
                            <span class="value" id="mandelbrot-js-time">Not run</span>
                        </div>
                        <div class="result-row">
                            <label>WASM Time:</label>
                            <span class="value" id="mandelbrot-wasm-time">Not run</span>
                        </div>
                        <div class="result-row">
                            <label>Winner:</label>
                            <span class="value" id="mandelbrot-winner">-</span>
                        </div>
                    </div>
                </div>

                <div class="benchmark-card">
                    <h3>Matrix Multiplication (128x128)</h3>
                    <div class="benchmark-controls">
                        <button onclick="runBenchmark('matrix-js')">Run JS</button>
                        <button onclick="runBenchmark('matrix-wasm')">Run WASM</button>
                    </div>
                    <div class="results">
                        <div class="result-row">
                            <label>JS Time:</label>
                            <span class="value" id="matrix-js-time">Not run</span>
                        </div>
                        <div class="result-row">
                            <label>WASM Time:</label>
                            <span class="value" id="matrix-wasm-time">Not run</span>
                        </div>
                        <div class="result-row">
                            <label>Winner:</label>
                            <span class="value" id="matrix-winner">-</span>
                        </div>
                    </div>
                </div>

                <div class="benchmark-card">
                    <h3>FFT Simulation (1024 samples)</h3>
                    <div class="benchmark-controls">
                        <button onclick="runBenchmark('fft-js')">Run JS</button>
                        <button onclick="runBenchmark('fft-wasm')">Run WASM</button>
                    </div>
                    <div class="results">
                        <div class="result-row">
                            <label>JS Time:</label>
                            <span class="value" id="fft-js-time">Not run</span>
                        </div>
                        <div class="result-row">
                            <label>WASM Time:</label>
                            <span class="value" id="fft-wasm-time">Not run</span>
                        </div>
                        <div class="result-row">
                            <label>Winner:</label>
                            <span class="value" id="fft-winner">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="benchmark-section">
            <div class="section-title">Raw Speed Operations</div>
            <div class="benchmark-grid">
                <div class="benchmark-card">
                    <h3>Array Iteration (1M elements)</h3>
                    <div class="benchmark-controls">
                        <button onclick="runBenchmark('iteration-js')">Run JS</button>
                        <button onclick="runBenchmark('iteration-wasm')">Run WASM</button>
                    </div>
                    <div class="results">
                        <div class="result-row">
                            <label>JS Time:</label>
                            <span class="value" id="iteration-js-time">Not run</span>
                        </div>
                        <div class="result-row">
                            <label>WASM Time:</label>
                            <span class="value" id="iteration-wasm-time">Not run</span>
                        </div>
                        <div class="result-row">
                            <label>Winner:</label>
                            <span class="value" id="iteration-winner">-</span>
                        </div>
                    </div>
                </div>

                <div class="benchmark-card">
                    <h3>Memory Operations (10M bytes)</h3>
                    <div class="benchmark-controls">
                        <button onclick="runBenchmark('memory-js')">Run JS</button>
                        <button onclick="runBenchmark('memory-wasm')">Run WASM</button>
                    </div>
                    <div class="results">
                        <div class="result-row">
                            <label>JS Time:</label>
                            <span class="value" id="memory-js-time">Not run</span>
                        </div>
                        <div class="result-row">
                            <label>WASM Time:</label>
                            <span class="value" id="memory-wasm-time">Not run</span>
                        </div>
                        <div class="result-row">
                            <label>Winner:</label>
                            <span class="value" id="memory-winner">-</span>
                        </div>
                    </div>
                </div>

                <div class="benchmark-card">
                    <h3>Vector Operations (1M elements)</h3>
                    <div class="benchmark-controls">
                        <button onclick="runBenchmark('vector-js')">Run JS</button>
                        <button onclick="runBenchmark('vector-wasm')">Run WASM</button>
                    </div>
                    <div class="results">
                        <div class="result-row">
                            <label>JS Time:</label>
                            <span class="value" id="vector-js-time">Not run</span>
                        </div>
                        <div class="result-row">
                            <label>WASM Time:</label>
                            <span class="value" id="vector-wasm-time">Not run</span>
                        </div>
                        <div class="result-row">
                            <label>Winner:</label>
                            <span class="value" id="vector-winner">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="benchmark-section">
            <div class="section-title">Heavy Algorithms</div>
            <div class="benchmark-grid">
                <div class="benchmark-card">
                    <h3>Prime Generation (100k limit)</h3>
                    <div class="benchmark-controls">
                        <button onclick="runBenchmark('primes-js')">Run JS</button>
                        <button onclick="runBenchmark('primes-wasm')">Run WASM</button>
                    </div>
                    <div class="results">
                        <div class="result-row">
                            <label>JS Time:</label>
                            <span class="value" id="primes-js-time">Not run</span>
                        </div>
                        <div class="result-row">
                            <label>WASM Time:</label>
                            <span class="value" id="primes-wasm-time">Not run</span>
                        </div>
                        <div class="result-row">
                            <label>Winner:</label>
                            <span class="value" id="primes-winner">-</span>
                        </div>
                    </div>
                </div>

                <div class="benchmark-card">
                    <h3>Fibonacci (n=30)</h3>
                    <div class="benchmark-controls">
                        <button onclick="runBenchmark('fib-js')">Run JS</button>
                        <button onclick="runBenchmark('fib-wasm')">Run WASM</button>
                    </div>
                    <div class="results">
                        <div class="result-row">
                            <label>JS Time:</label>
                            <span class="value" id="fib-js-time">Not run</span>
                        </div>
                        <div class="result-row">
                            <label>WASM Time:</label>
                            <span class="value" id="fib-wasm-time">Not run</span>
                        </div>
                        <div class="result-row">
                            <label>Winner:</label>
                            <span class="value" id="fib-winner">-</span>
                        </div>
                    </div>
                </div>

                <div class="benchmark-card">
                    <h3>Data Processing (100 iterations)</h3>
                    <div class="benchmark-controls">
                        <button onclick="runBenchmark('data-js')">Run JS</button>
                        <button onclick="runBenchmark('data-wasm')">Run WASM</button>
                    </div>
                    <div class="results">
                        <div class="result-row">
                            <label>JS Time:</label>
                            <span class="value" id="data-js-time">Not run</span>
                        </div>
                        <div class="result-row">
                            <label>WASM Time:</label>
                            <span class="value" id="data-wasm-time">Not run</span>
                        </div>
                        <div class="result-row">
                            <label>Winner:</label>
                            <span class="value" id="data-winner">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="summary">
            <h2>üìä Summary Statistics</h2>
            <div class="summary-stats">
                <div class="stat-box">
                    <div class="stat-label">Total Tests Run</div>
                    <div class="stat-value" id="total-tests">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">WASM Wins</div>
                    <div class="stat-value faster" id="wasm-wins">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">JS Wins</div>
                    <div class="stat-value slower" id="js-wins">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Avg WASM Speedup</div>
                    <div class="stat-value" id="avg-speedup">-</div>
                </div>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="saveResultsAsJSON()" style="background: #4caf50;">üíæ Save as JSON</button>
                <button onclick="saveResultsAsCSV()" style="background: #2196F3;">üìä Save as CSV</button>
                <button onclick="saveResultsAsHTML()" style="background: #ff9800;">üìÑ Save as HTML</button>
            </div>
        </div>

        <div class="visualization-section">
            <h2>üìà Performance Visualizations</h2>
            <p style="color: #666; margin-bottom: 20px;">Run benchmarks above to see real-time performance comparisons</p>
            
            <div class="controls-bar">
                <button onclick="updateAllCharts()" style="background: #667eea;">üîÑ Refresh Charts</button>
                <button onclick="clearCharts()" style="background: #f44336;">üóëÔ∏è Clear Data</button>
            </div>

            <div class="chart-grid">
                <!-- Performance Comparison Bar Chart -->
                <div class="chart-container">
                    <div class="chart-title">‚ö° Overall Performance Comparison</div>
                    <div class="chart-wrapper">
                        <canvas id="performanceChart"></canvas>
                    </div>
                    <div class="performance-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #667eea;"></div>
                            <div class="legend-label">JavaScript</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ff6b6b;"></div>
                            <div class="legend-label">WebAssembly</div>
                        </div>
                    </div>
                </div>

                <!-- Speedup Factor Chart -->
                <div class="chart-container">
                    <div class="chart-title">üöÄ WASM Speedup Factor</div>
                    <div class="chart-wrapper">
                        <canvas id="speedupChart"></canvas>
                    </div>
                    <div class="performance-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #4caf50;"></div>
                            <div class="legend-label">WASM Faster</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ff9800;"></div>
                            <div class="legend-label">JS Faster</div>
                        </div>
                    </div>
                </div>

                <!-- Execution Time Radar Chart -->
                <div class="chart-container">
                    <div class="chart-title">üìä Execution Time Radar</div>
                    <div class="chart-wrapper">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>

                <!-- Category Performance -->
                <div class="chart-container">
                    <div class="chart-title">üìÇ Performance by Category</div>
                    <div class="chart-wrapper">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>

            <div style="margin-top: 30px;">
                <h3 style="color: #333; margin-bottom: 15px;">üìâ Key Metrics</h3>
                <div class="stats-grid">
                    <div class="metric-card">
                        <div class="metric-title">Avg JS Time</div>
                        <div class="metric-value" id="metric-js-avg">-</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-title">Avg WASM Time</div>
                        <div class="metric-value" id="metric-wasm-avg">-</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-title">Total Tests</div>
                        <div class="metric-value" id="metric-total">0</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-title">Overall Winner</div>
                        <div class="metric-value" id="metric-winner">-</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-title">Min Time</div>
                        <div class="metric-value" id="metric-min">-</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-title">Max Time</div>
                        <div class="metric-value" id="metric-max">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load JavaScript benchmarks first -->
    <script src="./benchmarks/js/benchmarks.js"></script>
    
    <!-- WASM initialization and benchmark runner -->
    <script type="module">
        let benchmarkResults = {
            js: {},
            wasm: {}
        };
        let resultsLog = [];
        let wasmModuleCache = null;

        // Dynamically import and initialize WASM module
        async function initWasm() {
            try {
                if (wasmModuleCache) {
                    return wasmModuleCache;
                }
                console.log('Loading WASM module...');
                
                // Import the WASM module (web target)
                const wasmModule = await import('./wasm_app/pkg/image_filter_wasm.js');
                
                // Initialize the WASM module
                await wasmModule.default();
                
                console.log('‚úì WASM module initialized successfully');
                console.log('Available functions:', Object.keys(wasmModule).filter(k => !k.startsWith('_')));
                wasmModuleCache = wasmModule;
                return wasmModule;
            } catch (e) {
                console.error('‚ùå Failed to load WASM module:', e);
                console.error('Stack:', e.stack);
                return null;
            }
        }

        // Make functions available globally
        window.wasmInitialized = false;

        async function runBenchmark(testName) {
            const [benchmark, implementation] = testName.split('-');
            
            try {
                let duration;

                if (implementation === 'js') {
                    duration = runJSBenchmark(benchmark);
                } else if (implementation === 'wasm') {
                    const wasmModule = await initWasm();
                    if (!wasmModule) {
                        alert('WASM module failed to load. Check console for errors.');
                        return;
                    }
                    duration = runWasmBenchmark(benchmark, wasmModule);
                } else {
                    return;
                }

                const resultId = `${benchmark}-${implementation}-time`;
                const element = document.getElementById(resultId);
                if (element) {
                    element.textContent = `${duration.toFixed(2)}ms`;
                }

                // Store result
                benchmarkResults[implementation][benchmark] = duration;
                resultsLog.push({
                    benchmark,
                    implementation,
                    duration,
                    timestamp: new Date().toISOString()
                });

                // Update comparison
                updateComparison(benchmark);
                updateSummary();

            } catch (error) {
                console.error(`Error running ${testName}:`, error);
                alert(`Error: ${error.message}`);
            }
        }

        function runJSBenchmark(benchmark) {
            const startTime = performance.now();
            
            switch (benchmark) {
                case 'mandelbrot':
                    mandelbrotJS(512, 512, 100);
                    break;
                case 'matrix':
                    matrixMultiplicationJS(128);
                    break;
                case 'fft':
                    fftSimulationJS(1024);
                    break;
                case 'iteration':
                    arrayIterationJS(1000000);
                    break;
                case 'memory':
                    memoryOperationsJS(10000000);
                    break;
                case 'vector':
                    vectorOperationsJS(1000000);
                    break;
                case 'primes':
                    primeGenerationJS(100000);
                    break;
                case 'fib':
                    fibonacciJS(50);
                    break;
                case 'data':
                    dataProcessingJS(100);
                    break;
                default:
                    return 0;
            }

            const endTime = performance.now();
            return endTime - startTime;
        }

        function runWasmBenchmark(benchmark, wasmModule) {
            const startTime = performance.now();
            
            switch (benchmark) {
                case 'mandelbrot':
                    wasmModule.mandelbrot_wasm(512, 512, 100);
                    break;
                case 'matrix':
                    wasmModule.matrix_multiplication_wasm(128);
                    break;
                case 'fft':
                    wasmModule.fft_simulation_wasm(1024);
                    break;
                case 'iteration':
                    wasmModule.array_iteration_wasm(1000000);
                    break;
                case 'memory':
                    wasmModule.memory_operations_wasm(10000000);
                    break;
                case 'vector':
                    wasmModule.vector_operations_wasm(1000000);
                    break;
                case 'primes':
                    wasmModule.prime_generation_wasm(100000);
                    break;
                case 'fib':
                    wasmModule.fibonacci_wasm(50);
                    break;
                case 'data':
                    wasmModule.data_processing_wasm(100);
                    break;
                default:
                    return 0;
            }

            const endTime = performance.now();
            return endTime - startTime;
        }

        function updateComparison(benchmark) {
            const jsTime = benchmarkResults.js[benchmark];
            const wasmTime = benchmarkResults.wasm[benchmark];

            if (jsTime !== undefined && wasmTime !== undefined) {
                const winnerId = `${benchmark}-winner`;
                const winner = document.getElementById(winnerId);
                
                if (jsTime < wasmTime) {
                    winner.textContent = `JS (${(wasmTime / jsTime).toFixed(2)}x faster)`;
                    winner.className = 'value faster';
                } else {
                    winner.textContent = `WASM (${(jsTime / wasmTime).toFixed(2)}x faster)`;
                    winner.className = 'value faster';
                }
            }
        }

        function updateSummary() {
            const comparisons = Object.keys(benchmarkResults.js).filter(
                b => benchmarkResults.wasm[b] !== undefined
            );

            if (comparisons.length === 0) return;

            const wasmWins = comparisons.filter(
                b => benchmarkResults.wasm[b] < benchmarkResults.js[b]
            ).length;

            const jsWins = comparisons.length - wasmWins;
            
            const speedups = comparisons.map(b => {
                const ratio = benchmarkResults.js[b] / benchmarkResults.wasm[b];
                return Math.max(ratio, 1 / ratio);
            });

            const avgSpeedup = speedups.reduce((a, b) => a + b, 0) / speedups.length;

            document.getElementById('total-tests').textContent = comparisons.length;
            document.getElementById('wasm-wins').textContent = wasmWins;
            document.getElementById('js-wins').textContent = jsWins;
            document.getElementById('avg-speedup').textContent = `${avgSpeedup.toFixed(2)}x`;

            // Log results
            console.log('Benchmark Results:', {
                comparisons,
                wasmWins,
                jsWins,
                avgSpeedup,
                fullResults: resultsLog
            });

            updateAllCharts();
        }

        // Chart instances
        let charts = {};

        function updateAllCharts() {
            updatePerformanceChart();
            updateSpeedupChart();
            updateRadarChart();
            updateCategoryChart();
            updateMetrics();
        }

        function updatePerformanceChart() {
            const ctx = document.getElementById('performanceChart');
            if (!ctx) return;

            const benchmarks = Object.keys(benchmarkResults.js).filter(
                b => benchmarkResults.wasm[b] !== undefined
            );

            const jsData = benchmarks.map(b => benchmarkResults.js[b]);
            const wasmData = benchmarks.map(b => benchmarkResults.wasm[b]);

            if (charts.performance) {
                charts.performance.destroy();
            }

            charts.performance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: benchmarks,
                    datasets: [
                        {
                            label: 'JavaScript (ms)',
                            data: jsData,
                            backgroundColor: '#667eea',
                            borderColor: '#667eea',
                            borderWidth: 1
                        },
                        {
                            label: 'WebAssembly (ms)',
                            data: wasmData,
                            backgroundColor: '#ff6b6b',
                            borderColor: '#ff6b6b',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Execution Time (ms)'
                            }
                        }
                    }
                }
            });
        }

        function updateSpeedupChart() {
            const ctx = document.getElementById('speedupChart');
            if (!ctx) return;

            const benchmarks = Object.keys(benchmarkResults.js).filter(
                b => benchmarkResults.wasm[b] !== undefined
            );

            const speedups = benchmarks.map(b => {
                const jsTime = benchmarkResults.js[b];
                const wasmTime = benchmarkResults.wasm[b];
                return (jsTime / wasmTime).toFixed(2);
            });

            const colors = benchmarks.map(b => {
                const jsTime = benchmarkResults.js[b];
                const wasmTime = benchmarkResults.wasm[b];
                return jsTime < wasmTime ? '#ff9800' : '#4caf50';
            });

            if (charts.speedup) {
                charts.speedup.destroy();
            }

            charts.speedup = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: benchmarks,
                    datasets: [
                        {
                            label: 'Speedup Factor (JS / WASM)',
                            data: speedups,
                            backgroundColor: colors,
                            borderColor: colors,
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateRadarChart() {
            const ctx = document.getElementById('radarChart');
            if (!ctx) return;

            const benchmarks = Object.keys(benchmarkResults.js).filter(
                b => benchmarkResults.wasm[b] !== undefined
            );

            if (benchmarks.length === 0) return;

            const jsData = benchmarks.map(b => benchmarkResults.js[b]);
            const wasmData = benchmarks.map(b => benchmarkResults.wasm[b]);

            if (charts.radar) {
                charts.radar.destroy();
            }

            charts.radar = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: benchmarks,
                    datasets: [
                        {
                            label: 'JavaScript',
                            data: jsData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            pointBackgroundColor: '#667eea',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        },
                        {
                            label: 'WebAssembly',
                            data: wasmData,
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            borderWidth: 2,
                            pointBackgroundColor: '#ff6b6b',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateCategoryChart() {
            const ctx = document.getElementById('categoryChart');
            if (!ctx) return;

            const categories = {
                'Complex Math': ['mandelbrot', 'matrix', 'fft'],
                'Raw Speed': ['iteration', 'memory', 'vector'],
                'Heavy Algorithms': ['primes', 'fib', 'data']
            };

            const categoryData = {};
            let jsWinsByCategory = {};
            let wasmWinsByCategory = {};

            Object.entries(categories).forEach(([cat, benchmarks]) => {
                let jsWins = 0, wasmWins = 0;
                benchmarks.forEach(b => {
                    if (benchmarkResults.js[b] !== undefined && benchmarkResults.wasm[b] !== undefined) {
                        if (benchmarkResults.js[b] < benchmarkResults.wasm[b]) {
                            jsWins++;
                        } else {
                            wasmWins++;
                        }
                    }
                });
                jsWinsByCategory[cat] = jsWins;
                wasmWinsByCategory[cat] = wasmWins;
            });

            if (charts.category) {
                charts.category.destroy();
            }

            charts.category = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(jsWinsByCategory),
                    datasets: [
                        {
                            label: 'WASM Wins',
                            data: Object.values(wasmWinsByCategory),
                            backgroundColor: '#ff6b6b',
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        {
                            label: 'JS Wins',
                            data: Object.values(jsWinsByCategory),
                            backgroundColor: '#667eea',
                            borderColor: '#fff',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateMetrics() {
            const benchmarks = Object.keys(benchmarkResults.js).filter(
                b => benchmarkResults.wasm[b] !== undefined
            );

            if (benchmarks.length === 0) {
                document.getElementById('metric-js-avg').textContent = '-';
                document.getElementById('metric-wasm-avg').textContent = '-';
                document.getElementById('metric-total').textContent = '0';
                document.getElementById('metric-winner').textContent = '-';
                document.getElementById('metric-min').textContent = '-';
                document.getElementById('metric-max').textContent = '-';
                return;
            }

            const jsTimes = benchmarks.map(b => benchmarkResults.js[b]);
            const wasmTimes = benchmarks.map(b => benchmarkResults.wasm[b]);

            const jsAvg = jsTimes.reduce((a, b) => a + b, 0) / jsTimes.length;
            const wasmAvg = wasmTimes.reduce((a, b) => a + b, 0) / wasmTimes.length;

            const allTimes = [...jsTimes, ...wasmTimes];
            const minTime = Math.min(...allTimes);
            const maxTime = Math.max(...allTimes);

            const wasmWins = benchmarks.filter(b => benchmarkResults.wasm[b] < benchmarkResults.js[b]).length;
            const jsWins = benchmarks.length - wasmWins;

            document.getElementById('metric-js-avg').textContent = jsAvg.toFixed(2) + 'ms';
            document.getElementById('metric-wasm-avg').textContent = wasmAvg.toFixed(2) + 'ms';
            document.getElementById('metric-total').textContent = benchmarks.length;
            document.getElementById('metric-winner').textContent = jsAvg < wasmAvg ? 'JS' : 'WASM';
            document.getElementById('metric-min').textContent = minTime.toFixed(2) + 'ms';
            document.getElementById('metric-max').textContent = maxTime.toFixed(2) + 'ms';
        }

        function clearCharts() {
            benchmarkResults = { js: {}, wasm: {} };
            resultsLog = [];
            Object.values(charts).forEach(chart => chart?.destroy?.());
            charts = {};
            updateMetrics();
            
            // Reset all result displays
            document.querySelectorAll('.value[id$="-time"]').forEach(el => {
                el.textContent = 'Not run';
            });
            document.querySelectorAll('[id$="-winner"]').forEach(el => {
                el.textContent = '-';
            });
            document.getElementById('total-tests').textContent = '0';
            document.getElementById('wasm-wins').textContent = '0';
            document.getElementById('js-wins').textContent = '0';
            document.getElementById('avg-speedup').textContent = '-';
        }

        // Auto-run all benchmarks
        async function runAllBenchmarks() {
            const tests = [
                'mandelbrot-js', 'mandelbrot-wasm',
                'matrix-js', 'matrix-wasm',
                'fft-js', 'fft-wasm',
                'iteration-js', 'iteration-wasm',
                'memory-js', 'memory-wasm',
                'vector-js', 'vector-wasm',
                'primes-js', 'primes-wasm',
                'fib-js', 'fib-wasm',
                'data-js', 'data-wasm'
            ];

            for (const test of tests) {
                await new Promise(resolve => setTimeout(() => {
                    runBenchmark(test);
                    resolve();
                }, 100));
            }
        }

        function saveResultsAsJSON() {
            const data = {
                timestamp: new Date().toISOString(),
                results: resultsLog,
                summary: {
                    totalTests: resultsLog.length,
                    benchmarkResults,
                    averageJSTime: Object.values(benchmarkResults.js).reduce((a, b) => a + b, 0) / Object.keys(benchmarkResults.js).length || 0,
                    averageWASMTime: Object.values(benchmarkResults.wasm).reduce((a, b) => a + b, 0) / Object.keys(benchmarkResults.wasm).length || 0
                }
            };
            downloadFile(JSON.stringify(data, null, 2), 'benchmark-results.json', 'application/json');
        }

        function saveResultsAsCSV() {
            let csv = 'Benchmark,Implementation,Duration (ms),Timestamp\n';
            
            resultsLog.forEach(result => {
                csv += `"${result.benchmark}","${result.implementation}","${result.duration.toFixed(2)}","${result.timestamp}"\n`;
            });

            downloadFile(csv, 'benchmark-results.csv', 'text/csv');
        }

        function saveResultsAsHTML() {
            const html = `<!DOCTYPE html>
<html>
<head>
    <title>Benchmark Results - ${new Date().toISOString()}</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        h1 { color: #333; }
        .summary { background: #e3f2fd; padding: 15px; border-radius: 4px; margin: 20px 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #667eea; color: white; }
        tr:hover { background: #f5f5f5; }
        .faster { color: #4caf50; font-weight: bold; }
        .slower { color: #f44336; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Benchmark Results Report</h1>
        <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
        
        <div class="summary">
            <h2>Summary</h2>
            <p><strong>Total Tests Run:</strong> ${resultsLog.length}</p>
            <p><strong>Unique Benchmarks:</strong> ${new Set(resultsLog.map(r => r.benchmark)).size}</p>
            <p><strong>JS Tests:</strong> ${resultsLog.filter(r => r.implementation === 'js').length}</p>
            <p><strong>WASM Tests:</strong> ${resultsLog.filter(r => r.implementation === 'wasm').length}</p>
        </div>

        <h2>Detailed Results</h2>
        <table>
            <thead>
                <tr>
                    <th>Benchmark</th>
                    <th>Implementation</th>
                    <th>Duration (ms)</th>
                    <th>Timestamp</th>
                </tr>
            </thead>
            <tbody>
                ${resultsLog.map(r => `
                <tr>
                    <td>${r.benchmark}</td>
                    <td><strong>${r.implementation.toUpperCase()}</strong></td>
                    <td>${r.duration.toFixed(2)}</td>
                    <td>${new Date(r.timestamp).toLocaleString()}</td>
                </tr>
                `).join('')}
            </tbody>
        </table>

        <h2>Performance Comparison</h2>
        <table>
            <thead>
                <tr>
                    <th>Benchmark</th>
                    <th>JS Time (ms)</th>
                    <th>WASM Time (ms)</th>
                    <th>Winner</th>
                    <th>Speedup</th>
                </tr>
            </thead>
            <tbody>
                ${Object.keys(benchmarkResults.js)
                    .filter(b => benchmarkResults.wasm[b] !== undefined)
                    .map(b => {
                        const jsTime = benchmarkResults.js[b];
                        const wasmTime = benchmarkResults.wasm[b];
                        const winner = jsTime < wasmTime ? 'JS' : 'WASM';
                        const speedup = Math.max(jsTime, wasmTime) / Math.min(jsTime, wasmTime);
                        return `
                        <tr>
                            <td>${b}</td>
                            <td>${jsTime.toFixed(2)}</td>
                            <td>${wasmTime.toFixed(2)}</td>
                            <td><span class="${winner === 'JS' ? 'slower' : 'faster'}">${winner}</span></td>
                            <td>${speedup.toFixed(2)}x</td>
                        </tr>
                        `;
                    })
                    .join('')}
            </tbody>
        </table>
    </div>
</body>
</html>`;
            downloadFile(html, 'benchmark-results.html', 'text/html');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Make functions available globally for HTML onclick handlers
        window.runBenchmark = runBenchmark;
        window.runAllBenchmarks = runAllBenchmarks;
        window.saveResultsAsJSON = saveResultsAsJSON;
        window.saveResultsAsCSV = saveResultsAsCSV;
        window.saveResultsAsHTML = saveResultsAsHTML;
        window.updateAllCharts = updateAllCharts;
        window.clearCharts = clearCharts;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('‚úì Benchmark page loaded. Click buttons to run tests.');
        });
    </script>
</body>
</html>
