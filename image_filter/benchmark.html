<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generalized WASM vs JS Benchmarks</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #1a1a1a; margin-bottom: 30px; }
        
        .control-panel { background: #e3f2fd; padding: 20px; border-radius: 8px; border-left: 5px solid #2196f3; margin-bottom: 30px; }
        .btn-main { background: #2196f3; color: white; border: none; padding: 12px 24px; font-size: 16px; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; transition: background 0.2s; }
        .btn-main:hover { background: #1976d2; }
        .btn-main:disabled { background: #ccc; cursor: wait; }

        .results-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .result-card { border: 1px solid #eee; padding: 20px; border-radius: 8px; background: #fff; position: relative; }
        .result-card h3 { margin-top: 0; color: #333; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
        
        .stat-row { display: flex; justify-content: space-between; margin: 10px 0; font-family: 'Courier New', monospace; }
        .stat-label { font-weight: bold; color: #555; }
        .stat-val { color: #333; }
        .winner { color: #4caf50; font-weight: bold; }
        
        .chart-container { margin-top: 40px; height: 400px; }
        
        .memory-tag { font-size: 0.8em; padding: 2px 6px; background: #eee; border-radius: 4px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”¬ Generalized WASM Benchmarks</h1>
        <p style="text-align:center; color:#666; margin-bottom:20px;">
            Testing on Real-World, Dynamic Datasets (Time & Space Complexity)
        </p>

        <div class="control-panel">
            <button id="runBtn" class="btn-main" onclick="runAllTests()">RUN ALL 4 GENERALIZED TESTS</button>
            <p id="status" style="text-align:center; margin-top:10px; font-style:italic; color:#666;"></p>
        </div>

        <div class="results-grid">
            <div class="result-card" id="card-matrix">
                <h3>1. Matrix Multiplication (N x N)</h3>
                <div class="stat-row"><span class="stat-label">Input:</span> <span>400x400 Matrix (Dynamic)</span></div>
                <div class="stat-row"><span class="stat-label">JS Time:</span> <span class="stat-val" id="matrix-js">-</span></div>
                <div class="stat-row"><span class="stat-label">WASM Time:</span> <span class="stat-val" id="matrix-wasm">-</span></div>
                <div class="stat-row"><span class="stat-label">Speedup:</span> <span class="winner" id="matrix-speedup">-</span></div>
            </div>

            <div class="result-card" id="card-image">
                <h3>2. Image Processing (Greyscale)</h3>
                <div class="stat-row"><span class="stat-label">Input:</span> <span>4K Image (External API)</span></div>
                <div class="stat-row"><span class="stat-label">JS Time:</span> <span class="stat-val" id="image-js">-</span></div>
                <div class="stat-row"><span class="stat-label">WASM Time:</span> <span class="stat-val" id="image-wasm">-</span></div>
                <div class="stat-row"><span class="stat-label">Speedup:</span> <span class="winner" id="image-speedup">-</span></div>
            </div>

            <div class="result-card" id="card-sort">
                <h3>3. Merge Sort</h3>
                <div class="stat-row"><span class="stat-label">Input:</span> <span>1 Million Integers</span></div>
                <div class="stat-row"><span class="stat-label">JS Time:</span> <span class="stat-val" id="sort-js">-</span></div>
                <div class="stat-row"><span class="stat-label">WASM Time:</span> <span class="stat-val" id="sort-wasm">-</span></div>
                <div class="stat-row"><span class="stat-label">Speedup:</span> <span class="winner" id="sort-speedup">-</span></div>
            </div>

            <div class="result-card" id="card-kmeans">
                <h3>4. K-Means Clustering</h3>
                <div class="stat-row"><span class="stat-label">Input:</span> <span>50k Points, K=5</span></div>
                <div class="stat-row"><span class="stat-label">JS Time:</span> <span class="stat-val" id="kmeans-js">-</span></div>
                <div class="stat-row"><span class="stat-label">WASM Time:</span> <span class="stat-val" id="kmeans-wasm">-</span></div>
                <div class="stat-row"><span class="stat-label">Speedup:</span> <span class="winner" id="kmeans-speedup">-</span></div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="perfChart"></canvas>
        </div>
    </div>

    <script src="./benchmarks/js/benchmarks.js"></script>
    <script type="module">
        // --- MEMORY HELPER ---
        function getMemoryUsage(isWasm = false, wasmModule = null) {
            if (isWasm && wasmModule && wasmModule.memory) {
                const bytes = wasmModule.memory.buffer.byteLength;
                return (bytes / 1024 / 1024).toFixed(2) + " MB (Linear)";
            }
            if (window.performance && window.performance.memory) {
                const bytes = window.performance.memory.usedJSHeapSize;
                return (bytes / 1024 / 1024).toFixed(2) + " MB (Heap)";
            }
            return "N/A";
        }

        // --- INIT WASM ---
        let wasm = null;
        async function init() {
            if (wasm) return wasm;
            const module = await import('./wasm_app/pkg/image_filter_wasm.js');
            await module.default();
            wasm = module;
            return wasm;
        }

        // --- UPDATE UI HELPER ---
        function updateUI(id, jsTime, wasmTime, jsMem, wasmMem) {
            document.getElementById(`${id}-js`).innerHTML = `${jsTime.toFixed(2)} ms <span class="memory-tag">${jsMem}</span>`;
            document.getElementById(`${id}-wasm`).innerHTML = `${wasmTime.toFixed(2)} ms <span class="memory-tag">${wasmMem}</span>`;
            
            const speedup = jsTime / wasmTime;
            const el = document.getElementById(`${id}-speedup`);
            el.textContent = speedup > 1 ? `${speedup.toFixed(2)}x Faster` : `${(1/speedup).toFixed(2)}x Slower`;
            el.style.color = speedup > 1 ? '#4caf50' : '#f44336';
        }

        // --- MAIN RUNNER ---
        window.runAllTests = async function() {
            const btn = document.getElementById('runBtn');
            const status = document.getElementById('status');
            btn.disabled = true;
            status.textContent = "Initializing Wasm...";
            
            try {
                await init();
                
                // 1. MATRIX
                status.textContent = "Running Matrix Multiplication (400x400)...";
                await new Promise(r => setTimeout(r, 50)); // Let UI update
                const N = 400;
                const matA = window.generateMatrix(N);
                const matB = window.generateMatrix(N);
                
                let t0 = performance.now();
                window.jsMultiplyMatrix(matA, matB, N);
                let tJS = performance.now() - t0;
                let memJS = getMemoryUsage(false);

                t0 = performance.now();
                wasm.multiply_matrices_dynamic(matA, matB, N);
                let tWasm = performance.now() - t0;
                let memWasm = getMemoryUsage(true, wasm);
                
                updateUI('matrix', tJS, tWasm, memJS, memWasm);

                // 2. IMAGE
                status.textContent = "Running Image Processing (4K Download)...";
                await new Promise(r => setTimeout(r, 50));
                const imgData = await window.fetchRealImage(3840, 2160);
                const rawBytes = imgData.data;

                t0 = performance.now();
                window.jsGrayscale(rawBytes);
                tJS = performance.now() - t0;
                memJS = getMemoryUsage(false);

                t0 = performance.now();
                wasm.grayscale_image(rawBytes);
                tWasm = performance.now() - t0;
                memWasm = getMemoryUsage(true, wasm);

                updateUI('image', tJS, tWasm, memJS, memWasm);

                // 3. MERGE SORT
                status.textContent = "Running Merge Sort (1 Million Items)...";
                await new Promise(r => setTimeout(r, 50));
                const sortData = window.generateRandomArray(1000000);
                const sortJS = new Int32Array(sortData);
                const sortWasm = new Int32Array(sortData);

                t0 = performance.now();
                window.jsMergeSort(Array.from(sortJS));
                tJS = performance.now() - t0;
                memJS = getMemoryUsage(false);

                t0 = performance.now();
                wasm.sort_array(sortWasm);
                tWasm = performance.now() - t0;
                memWasm = getMemoryUsage(true, wasm);

                updateUI('sort', tJS, tWasm, memJS, memWasm);

                // 4. K-MEANS
                status.textContent = "Running K-Means (50k points)...";
                await new Promise(r => setTimeout(r, 50));
                const points = window.generatePoints(50000);
                
                t0 = performance.now();
                window.jsKMeans(points, 5, 20);
                tJS = performance.now() - t0;
                memJS = getMemoryUsage(false);

                t0 = performance.now();
                wasm.k_means_clustering(points, 5, 20);
                tWasm = performance.now() - t0;
                memWasm = getMemoryUsage(true, wasm);

                updateUI('kmeans', tJS, tWasm, memJS, memWasm);

                // Update Chart
                updateChart();
                status.textContent = "All Tests Complete!";
                btn.disabled = false;

            } catch (e) {
                console.error(e);
                status.textContent = "Error: " + e.message;
                btn.disabled = false;
            }
        };

        // --- CHART ---
        let myChart = null;
        function updateChart() {
            const ctx = document.getElementById('perfChart');
            
            const getData = (id) => parseFloat(document.getElementById(`${id}-wasm`).textContent);
            const getJSData = (id) => parseFloat(document.getElementById(`${id}-js`).textContent);

            const labels = ['Matrix', 'Image', 'Sort', 'K-Means'];
            const wasmData = [getData('matrix'), getData('image'), getData('sort'), getData('kmeans')];
            const jsData = [getJSData('matrix'), getJSData('image'), getJSData('sort'), getJSData('kmeans')];

            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'JavaScript (ms)', data: jsData, backgroundColor: '#2196f3' },
                        { label: 'WASM (ms)', data: wasmData, backgroundColor: '#4caf50' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { type: 'logarithmic', title: { display: true, text: 'Time (ms) - Log Scale' } } }
                }
            });
        }
    </script>
</body>
</html>