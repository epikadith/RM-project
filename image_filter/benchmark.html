<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research Benchmark Suite (Final)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f8f9fa; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        
        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        h1 { margin: 0; font-size: 1.8em; color: #2c3e50; }
        .badge { background: #e9ecef; padding: 5px 12px; border-radius: 15px; font-size: 0.85em; font-weight: bold; color: #555; }

        /* Controls */
        .config-panel { background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #bbdefb; }
        .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .input-group label { display: block; font-size: 0.8em; font-weight: bold; color: #1565c0; margin-bottom: 5px; }
        .input-group input, .input-group select { width: 100%; padding: 8px; border: 1px solid #90caf9; border-radius: 4px; font-family: 'Courier New', monospace; }

        .btn-row { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn { padding: 12px 20px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 0.95em; flex: 1; }
        .btn-run { background: #2196f3; color: white; flex: 2; }
        .btn-run:hover { background: #1976d2; }
        .btn-run:disabled { background: #b0bec5; cursor: wait; }
        .btn-csv { background: #4caf50; color: white; }
        .btn-csv:hover { background: #388e3c; }
        .btn-import { background: #ff9800; color: white; position: relative; overflow: hidden; }
        .btn-import:hover { background: #f57c00; }
        .btn-import input { position: absolute; top: 0; left: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        .btn-clear { background: #ff5252; color: white; flex: 0.5; }
        .btn-clear:hover { background: #d32f2f; }

        /* Charts & Table */
        .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; height: 350px; }
        .chart-box { background: white; border: 1px solid #eee; border-radius: 8px; padding: 15px; display: flex; flex-direction: column; }
        .canvas-container { position: relative; flex: 1; min-height: 0; }

        .history-section { margin-top: 40px; }
        .data-table-container { overflow-x: auto; border: 1px solid #eee; border-radius: 8px; max-height: 400px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        th, td { padding: 10px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: bold; position: sticky; top: 0; }
        tr:hover { background: #f1f8ff; }
        .win-wasm { color: #2e7d32; font-weight: bold; }
        .win-js { color: #c62828; font-weight: bold; }
        .tag-platform { font-size: 0.75em; padding: 2px 6px; border-radius: 4px; background: #333; color: #fff; margin-right: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>üî¨ Research Benchmark Suite</h1>
                <div style="margin-top:5px; color:#666; font-size:0.9em;">Cross-Browser Data Aggregation & Analysis</div>
            </div>
            <div style="text-align: right;">
                <span class="badge" id="sys-os">Detecting...</span>
                <span class="badge" id="sys-browser">Detecting...</span>
            </div>
        </header>

        <div class="config-panel">
            <div class="config-grid">
                <div class="input-group"><label>Matrix Size (N)</label><input type="number" id="inp-matrix" value="400" step="100"></div>
                <div class="input-group"><label>Image Resolution</label>
                    <select id="inp-image">
                        <option value="3840,2160">4K (3840x2160)</option>
                        <option value="1920,1080">1080p (1920x1080)</option>
                        <option value="1280,720">720p (1280x720)</option>
                    </select>
                </div>
                <div class="input-group"><label>Sort Array Size</label><input type="number" id="inp-sort" value="1000000" step="500000"></div>
                <div class="input-group"><label>K-Means (Points)</label><input type="number" id="inp-kmeans" value="50000" step="10000"></div>
            </div>
            <div class="btn-row">
                <button id="runBtn" class="btn btn-run" onclick="runNewTests()">‚ñ∂ RUN TESTS</button>
                <button class="btn btn-csv" onclick="downloadMasterCSV()">üíæ EXPORT CSV</button>
                <button class="btn btn-import">üìÇ IMPORT CSV<input type="file" accept=".csv" onchange="importCSV(this)"></button>
                <button class="btn btn-clear" onclick="clearHistory()">üóëÔ∏è RESET</button>
            </div>
            <div id="status" style="text-align: center; margin-top: 10px; font-style: italic; color: #666;">Ready</div>
        </div>

        <div class="chart-grid">
            <div class="chart-box"><h3 style="margin:0 0 10px 0; font-size:1em; color:#555;">‚è±Ô∏è Execution Time (Log Scale)</h3><div class="canvas-container"><canvas id="timeChart"></canvas></div></div>
            <div class="chart-box"><h3 style="margin:0 0 10px 0; font-size:1em; color:#555;">üöÄ Speedup Factor</h3><div class="canvas-container"><canvas id="speedupChart"></canvas></div></div>
        </div>

        <div class="history-section">
            <div class="history-header"><h3>üìú Data History</h3><span class="badge" id="record-count">0 Records</span></div>
            <div class="data-table-container">
                <table id="history-table">
                    <thead><tr><th>Platform/Browser</th><th>Test Case</th><th>Parameters</th><th>JS Time</th><th>Wasm Time</th><th>Speedup</th><th>Memory (MB)</th></tr></thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="./benchmarks/js/benchmarks.js"></script>
    <script src="./cpp_app/cpp_benchmark.js" onerror="console.log('C++ module skipped')"></script>

    <script type="module">
        let history = JSON.parse(localStorage.getItem('research_benchmark_data')) || [];
        let rustWrappers = null; 
        let rustExports = null;
        let cppModule = null;

        detectSystem();
        updateUI();

        // ==========================================
        // 1. ROBUST MEMORY & SYSTEM CHECKER
        // ==========================================
        function detectSystem() {
            const ua = navigator.userAgent;
            let os = "Unknown";
            if (ua.includes("Win")) os = "Windows";
            else if (ua.includes("Mac")) os = "macOS";
            else if (ua.includes("Linux")) os = "Linux";
            else if (ua.includes("Android")) os = "Android";
            else if (ua.includes("iPhone") || ua.includes("iPad")) os = "iOS";

            // BROWSER DETECTION FIX: Check Edge BEFORE Chrome
            let browser = "Unknown";
            if (ua.indexOf("Edg") !== -1) browser = "Edge";
            else if (ua.indexOf("Chrome") !== -1) browser = "Chrome";
            else if (ua.indexOf("Firefox") !== -1) browser = "Firefox";
            else if (ua.indexOf("Safari") !== -1) browser = "Safari";

            document.getElementById('sys-os').textContent = os;
            document.getElementById('sys-browser').textContent = browser;
            return { os, browser };
        }

        function getMemory(isWasm, wasmInstance) {
            if (!isWasm) {
                if (window.performance && window.performance.memory) {
                    return (window.performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(1);
                }
                return "N/A"; 
            }
            try {
                if (wasmInstance && wasmInstance.memory && wasmInstance.memory.buffer) {
                    return (wasmInstance.memory.buffer.byteLength / 1024 / 1024).toFixed(1);
                }
                if (wasmInstance && wasmInstance.HEAP8) {
                    return (wasmInstance.HEAP8.buffer.byteLength / 1024 / 1024).toFixed(1);
                }
            } catch(e) { console.error("Mem check failed", e); }
            return "-";
        }

        // ==========================================
        // 2. INIT MODULES
        // ==========================================
        async function initModules() {
            if (!rustWrappers) {
                const m = await import('./wasm_app/pkg/image_filter_wasm.js');
                rustWrappers = m;
                rustExports = await m.default(); 
            }
            if (!cppModule && window.createCppModule) {
                try { cppModule = await window.createCppModule(); } catch(e) {}
            }
        }

        // ==========================================
        // 3. TEST RUNNER
        // ==========================================
        window.runNewTests = async function() {
            const btn = document.getElementById('runBtn');
            const status = document.getElementById('status');
            btn.disabled = true;
            try {
                status.textContent = "Initializing...";
                await initModules();
                const sys = detectSystem();
                const conf = {
                    matrix: parseInt(document.getElementById('inp-matrix').value),
                    img: document.getElementById('inp-image').value.split(','),
                    sort: parseInt(document.getElementById('inp-sort').value),
                    kmeans: parseInt(document.getElementById('inp-kmeans').value)
                };

                const runTest = async (name, params, jsFn, wasmFn) => {
                    let t0 = performance.now();
                    await jsFn(); 
                    let tJS = performance.now() - t0;
                    let mJS = getMemory(false);

                    t0 = performance.now();
                    await wasmFn();
                    let tWasm = performance.now() - t0;
                    let mWasm = getMemory(true, rustExports);
                    
                    const safeWasm = tWasm === 0 ? 0.01 : tWasm;
                    const speedup = parseFloat((tJS / safeWasm).toFixed(2));

                    history.push({
                        timestamp: new Date().toISOString(), platform: sys.os, browser: sys.browser,
                        test: name, params: params, js_time: parseFloat(tJS.toFixed(2)),
                        wasm_time: parseFloat(tWasm.toFixed(2)), speedup: speedup, js_mem: mJS, wasm_mem: mWasm
                    });
                    saveHistory();
                };

                status.textContent = `Matrix...`;
                const mA = window.generateMatrix(conf.matrix);
                const mB = window.generateMatrix(conf.matrix);
                await runTest('Matrix', `N=${conf.matrix}`, 
                    () => window.jsMultiplyMatrix(mA, mB, conf.matrix), 
                    () => rustWrappers.multiply_matrices_dynamic(mA, mB, conf.matrix));

                status.textContent = `Image...`;
                const imgData = await window.fetchRealImage(parseInt(conf.img[0]), parseInt(conf.img[1]));
                await runTest('Image', `${conf.img[0]}x${conf.img[1]}`, 
                    () => window.jsGrayscale(imgData.data), 
                    () => rustWrappers.grayscale_image(imgData.data));

                status.textContent = `Sorting...`;
                const sortArr = window.generateRandomArray(conf.sort);
                await runTest('Sort', `${(conf.sort/1e6).toFixed(1)}M`, 
                    () => window.jsMergeSort(Array.from(new Int32Array(sortArr))), 
                    () => rustWrappers.sort_array(new Int32Array(sortArr)));

                status.textContent = `K-Means...`;
                const pts = window.generatePoints(conf.kmeans);
                await runTest('K-Means', `P=${conf.kmeans}`, 
                    () => window.jsKMeans(pts, 5, 20), 
                    () => rustWrappers.k_means_clustering(pts, 5, 20));

                status.textContent = "‚úÖ Done!";
            } catch(e) { console.error(e); status.textContent = "Error: " + e.message; }
            btn.disabled = false;
        };

        // ==========================================
        // 4. UTILS (IMPORT/EXPORT)
        // ==========================================
        function saveHistory() { localStorage.setItem('research_benchmark_data', JSON.stringify(history)); updateUI(); }
        window.clearHistory = function() { if(confirm("Clear?")) { history = []; saveHistory(); } };
        
        window.importCSV = function(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const lines = e.target.result.split('\n');
                    let count = 0;
                    for (let i = 1; i < lines.length; i++) {
                        const cols = lines[i].split(',');
                        if (cols.length < 9) continue;
                        const rec = {
                            timestamp: cols[0], platform: cols[1], browser: cols[2], test: cols[3], params: cols[4],
                            js_time: parseFloat(cols[5]), wasm_time: parseFloat(cols[6]), speedup: parseFloat(cols[7]),
                            js_mem: cols[8], wasm_mem: cols[9]
                        };
                        if (!history.some(h => h.timestamp === rec.timestamp && h.test === rec.test)) { history.push(rec); count++; }
                    }
                    if (count > 0) { saveHistory(); alert(`Merged ${count} records!`); }
                } catch (err) { alert("Error: " + err.message); }
                input.value = ''; 
            };
            reader.readAsText(file);
        };

        window.downloadMasterCSV = function() {
            if(history.length === 0) { alert("No data!"); return; }
            let csv = "Timestamp,Platform,Browser,Test Name,Parameters,JS Time (ms),Wasm Time (ms),Speedup,JS Mem (MB),Wasm Mem (MB)\n";
            history.forEach(r => { csv += `${r.timestamp},${r.platform},${r.browser},${r.test},${r.params},${r.js_time},${r.wasm_time},${r.speedup},${r.js_mem},${r.wasm_mem}\n`; });
            const link = document.createElement("a");
            link.href = encodeURI("data:text/csv;charset=utf-8," + csv);
            link.download = "research_master_dataset.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        function updateUI() {
            const tbody = document.getElementById('table-body');
            document.getElementById('record-count').textContent = `${history.length} Records`;
            tbody.innerHTML = history.slice().reverse().map(r => `
                <tr>
                    <td><span class="tag-platform">${r.platform}</span><b>${r.browser}</b></td>
                    <td>${r.test}</td>
                    <td style="font-family:monospace; font-size:0.9em; color:#666;">${r.params}</td>
                    <td>${r.js_time}</td>
                    <td>${r.wasm_time}</td>
                    <td class="${r.speedup > 1 ? 'win-wasm' : 'win-js'}">${r.speedup}x</td>
                    <td style="font-size:0.85em;">${r.js_mem} / ${r.wasm_mem}</td>
                </tr>`).join('');
            updateCharts();
        }

        let charts = {};
        function updateCharts() {
            if(history.length === 0) return;
            try {
                const ctxTime = document.getElementById('timeChart');
                const ctxSpeed = document.getElementById('speedupChart');
                const labels = history.map(r => `${r.test.substring(0,4)} (${r.browser})`);
                const dataJS = history.map(r => r.js_time || 0);
                const dataWasm = history.map(r => r.wasm_time || 0);
                const dataSpeedup = history.map(r => (isFinite(r.speedup) ? r.speedup : 0));

                if(charts.time) charts.time.destroy();
                charts.time = new Chart(ctxTime, {
                    type: 'line',
                    data: { labels: labels, datasets: [{ label: 'JS (ms)', data: dataJS, borderColor: '#2196f3' }, { label: 'Wasm (ms)', data: dataWasm, borderColor: '#4caf50' }] },
                    options: { scales: { y: { type: 'logarithmic' } }, maintainAspectRatio: false, responsive: true }
                });

                if(charts.speed) charts.speed.destroy();
                charts.speed = new Chart(ctxSpeed, {
                    type: 'bar',
                    data: { labels: labels, datasets: [{ label: 'Speedup (x)', data: dataSpeedup, backgroundColor: dataSpeedup.map(v => v > 1 ? '#4caf50' : '#ff5252') }] },
                    options: { maintainAspectRatio: false, responsive: true }
                });
            } catch(e) {}
        }
    </script>
</body>