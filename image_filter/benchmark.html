<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rigorous Wasm Benchmark</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        /* --- THEMES --- */
        :root {
            /* Mohit Mode (Light) */
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text: #1f2937;
            --text-sec: #6b7280;
            --border: #e5e7eb;
            --input-bg: #ffffff;
            --table-stripe: #f9fafb;
            --success-bg: #d1fae5;
            --success-text: #065f46;
            --danger-bg: #fee2e2;
            --danger-text: #991b1b;
        }

        [data-theme="davan"] {
            /* Davan Mode (Dark) */
            --primary: #60a5fa;
            --primary-hover: #3b82f6;
            --bg-body: #111827;
            --bg-card: #1f2937;
            --text: #f3f4f6;
            --text-sec: #9ca3af;
            --border: #374151;
            --input-bg: #374151;
            --table-stripe: #2d3748;
            --success-bg: #064e3b;
            --success-text: #6ee7b7;
            --danger-bg: #7f1d1d;
            --danger-text: #fca5a5;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text); margin: 0; padding: 20px; transition: background 0.3s, color 0.3s; }
        
        .container { max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 320px 1fr; gap: 20px; }
        .card { background: var(--bg-card); border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid var(--border); transition: background 0.3s; }
        
        h1, h2, h3 { margin: 0 0 15px 0; color: var(--text); }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .badge { display: inline-block; padding: 4px 10px; background: var(--border); color: var(--text); border-radius: 20px; font-size: 0.8em; font-weight: 600; }
        
        label { display: block; font-size: 0.85em; font-weight: 600; margin-bottom: 5px; color: var(--text-sec); }
        input, select { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; background: var(--input-bg); color: var(--text); }
        
        .btn { width: 100%; padding: 10px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-bottom: 10px; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: #ffffff; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-primary:disabled { background: var(--border); cursor: not-allowed; color: var(--text-sec); }
        .btn-sec { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-sec:hover { background: var(--border); }
        
        .file-upload { position: relative; overflow: hidden; }
        .file-upload input { position: absolute; font-size: 100px; right: 0; top: 0; opacity: 0; cursor: pointer; }

        /* Table */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        th { text-align: left; padding: 12px; background: var(--border); color: var(--text); font-weight: 600; }
        td { padding: 12px; border-bottom: 1px solid var(--border); color: var(--text); }
        tr:nth-child(even) { background: var(--table-stripe); }
        
        .metric-val { font-family: 'Courier New', monospace; font-weight: 600; }
        .stat-detail { font-size: 0.8em; color: var(--text-sec); }
        .warn { color: #f59e0b; font-weight: bold; }
        .speedup-badge { padding: 4px 8px; border-radius: 6px; font-weight: bold; }
        .speedup-good { background: var(--success-bg); color: var(--success-text); }
        .speedup-bad { background: var(--danger-bg); color: var(--danger-text); }

        #overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 100; justify-content: center; align-items: center; flex-direction: column; color: white; backdrop-filter: blur(5px); }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        #themeBtn { margin-left: auto; width: auto; padding: 6px 12px; font-size: 0.85rem; }
    </style>
</head>
<body>

    <div class="container">
        <aside class="card">
            <h2>‚öôÔ∏è Config</h2>
            <div style="margin-bottom: 20px; padding: 10px; background: rgba(245, 158, 11, 0.1); border-left: 4px solid #f59e0b; font-size: 0.85em; color: var(--text);">
                <b>Scientific Rigor Mode:</b><br>
                ‚Ä¢ Warmup: 5 runs (Discarded)<br>
                ‚Ä¢ Sampling: 20 Iterations<br>
                ‚Ä¢ Metric: Mean ¬± StdDev
            </div>

            <label>Matrix Size (N)</label>
            <input type="number" id="inp-matrix" value="400">
            
            <label>Image Resolution</label>
            <select id="inp-image">
                <option value="3840,2160">4K (3840x2160)</option>
                <option value="1920,1080">1080p</option>
                <option value="5000,5000">5K (Stress)</option>
            </select>

            <label>Sort Array Size</label>
            <input type="number" id="inp-sort" value="1000000">

            <label>K-Means Points</label>
            <input type="number" id="inp-kmeans" value="50000">

            <button id="runBtn" class="btn btn-primary" onclick="runRigorousSuite()">
                <i class="fa-solid fa-vial"></i> Run Rigorous Test
            </button>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn btn-sec" onclick="downloadCSV()">
                    <i class="fa-solid fa-download"></i> Export
                </button>
                <button class="btn btn-sec file-upload">
                    <i class="fa-solid fa-upload"></i> Import
                    <input type="file" accept=".csv" onchange="importCSV(this)">
                </button>
            </div>
            
            <button class="btn btn-sec" onclick="clearData()" style="color: #ef4444; border-color: #fca5a5;">
                <i class="fa-solid fa-trash"></i> Reset Data
            </button>
        </aside>

        <main>
            <div class="card header-row">
                <div>
                    <h1>üìä Research Dashboard</h1>
                    <div style="color: var(--text-sec); font-size: 0.9em;">
                        Environment: <span id="sys-os" class="badge">Detecting...</span> 
                        <span id="sys-browser" class="badge">Detecting...</span>
                    </div>
                </div>
                <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 10px;">
                    <button id="themeBtn" class="btn btn-sec" onclick="toggleTheme()">
                        <i class="fa-solid fa-sun"></i> Mohit Mode
                    </button>
                    <div style="font-size: 0.85em; color: var(--text-sec);">
                        Samples: <span id="total-samples">0</span> | Last Run: <span id="last-run">-</span>
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div class="card">
                    <h3>Execution Time (Mean)</h3>
                    <div style="height: 250px;"><canvas id="timeChart"></canvas></div>
                </div>
                <div class="card">
                    <h3>Speedup (Wasm vs JS)</h3>
                    <div style="height: 250px;"><canvas id="speedupChart"></canvas></div>
                </div>
            </div>

            <div class="card">
                <h3>Statistical Data</h3>
                <div class="table-container">
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th>Test Case</th>
                                <th>JS Mean (œÉ)</th>
                                <th>Wasm Mean (œÉ)</th>
                                <th>Speedup</th>
                                <th>Peak Memory</th>
                                <th>Stability</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="overlay">
        <div class="spinner"></div>
        <h2 style="margin-top: 20px;">Running Benchmarks...</h2>
        <p id="status-text">Warming up JIT...</p>
        <div id="progress-bar" style="width: 300px; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; margin-top: 10px; overflow: hidden;">
            <div id="progress-fill" style="width: 0%; height: 100%; background: var(--primary); transition: width 0.2s;"></div>
        </div>
    </div>

    <script src="./benchmarks/js/benchmarks.js"></script>
    <script src="./cpp_app/cpp_benchmark.js" onerror="console.log('C++ skipped')"></script>

    <script type="module">
        // --- CONFIGURATION ---
        const WARMUP_ROUNDS = 5;
        const MEASURE_ROUNDS = 20;
        
        let history = JSON.parse(localStorage.getItem('research_stats_data')) || [];
        let rustWrappers = null, rustExports = null, cppModule = null;
        let charts = {};

        // Init
        initTheme();
        detectSystem();
        updateUI();

        // --- THEME LOGIC ---
        window.toggleTheme = function() {
            const body = document.body;
            const btn = document.getElementById('themeBtn');
            if (body.getAttribute('data-theme') === 'davan') {
                body.removeAttribute('data-theme');
                btn.innerHTML = '<i class="fa-solid fa-sun"></i> Mohit Mode';
                localStorage.setItem('theme', 'mohit');
            } else {
                body.setAttribute('data-theme', 'davan');
                btn.innerHTML = '<i class="fa-solid fa-moon"></i> Davan Mode';
                localStorage.setItem('theme', 'davan');
            }
            updateCharts();
        };

        function initTheme() {
            const saved = localStorage.getItem('theme') || 'mohit';
            if (saved === 'davan') {
                document.body.setAttribute('data-theme', 'davan');
                document.getElementById('themeBtn').innerHTML = '<i class="fa-solid fa-moon"></i> Davan Mode';
            }
        }

        // --- SYSTEM DETECTION ---
        function detectSystem() {
            const ua = navigator.userAgent;
            let os = ua.includes("Win") ? "Windows" : ua.includes("Mac") ? "macOS" : ua.includes("Linux") ? "Linux" : "Unknown";
            let browser = ua.includes("Edg") ? "Edge" : ua.includes("Chrome") ? "Chrome" : ua.includes("Firefox") ? "Firefox" : ua.includes("Safari") ? "Safari" : "Unknown";
            document.getElementById('sys-os').innerText = os;
            document.getElementById('sys-browser').innerText = browser;
            return { os, browser };
        }

        // --- MEMORY ---
        function getMemory(isWasm) {
            if (!isWasm) {
                return (window.performance && window.performance.memory) ? (window.performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(1) : "N/A";
            }
            try {
                if (rustExports && rustExports.memory) return (rustExports.memory.buffer.byteLength / 1024 / 1024).toFixed(1);
            } catch(e) {}
            return "-";
        }

        // --- STATS ---
        function calculateStats(times) {
            const n = times.length;
            const mean = times.reduce((a, b) => a + b, 0) / n;
            const variance = times.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / n;
            const stdDev = Math.sqrt(variance);
            const rsd = (stdDev / mean) * 100; 
            return { mean, stdDev, rsd, min: Math.min(...times), max: Math.max(...times) };
        }

        // --- RUNNER ---
        async function initModules() {
            if (!rustWrappers) {
                const m = await import('./wasm_app/pkg/image_filter_wasm.js');
                rustWrappers = m;
                rustExports = await m.default();
            }
        }

        window.runRigorousSuite = async function() {
            const overlay = document.getElementById('overlay');
            const status = document.getElementById('status-text');
            const prog = document.getElementById('progress-fill');
            overlay.style.display = 'flex';
            
            try {
                await initModules();
                const sys = detectSystem();
                
                const conf = {
                    matrix: parseInt(document.getElementById('inp-matrix').value),
                    img: document.getElementById('inp-image').value.split(','),
                    sort: parseInt(document.getElementById('inp-sort').value),
                    kmeans: parseInt(document.getElementById('inp-kmeans').value)
                };

                status.innerText = "Generating Data...";
                const matA = window.generateMatrix(conf.matrix);
                const matB = window.generateMatrix(conf.matrix);
                const imgData = await window.fetchRealImage(parseInt(conf.img[0]), parseInt(conf.img[1]));
                const sortData = window.generateRandomArray(conf.sort);
                const kmeansPts = window.generatePoints(conf.kmeans);

                const tests = [
                    { name: `Matrix (N=${conf.matrix})`, js: () => window.jsMultiplyMatrix(matA, matB, conf.matrix), wasm: () => rustWrappers.multiply_matrices_dynamic(matA, matB, conf.matrix) },
                    { name: `Image (${conf.img[0]}x${conf.img[1]})`, js: () => window.jsGrayscale(imgData.data), wasm: () => rustWrappers.grayscale_image(imgData.data) },
                    { name: `Sort (${(conf.sort/1e6).toFixed(1)}M)`, js: () => window.jsMergeSort(new Int32Array(sortData)), wasm: () => rustWrappers.sort_array(new Int32Array(sortData)) },
                    { name: `K-Means (P=${conf.kmeans})`, js: () => window.jsKMeans(kmeansPts, 5, 20), wasm: () => rustWrappers.k_means_clustering(kmeansPts, 5, 20) }
                ];

                const totalSteps = tests.length * (WARMUP_ROUNDS + MEASURE_ROUNDS) * 2; 
                let step = 0;

                for (const test of tests) {
                    const result = { test: test.name, platform: sys.os, browser: sys.browser, timestamp: new Date().toISOString(), js_samples: [], wasm_samples: [] };

                    for(let i=0; i<WARMUP_ROUNDS; i++) { status.innerText = `Warmup JS: ${test.name}`; await new Promise(r => setTimeout(r, 10)); test.js(); step++; prog.style.width = `${(step/totalSteps)*100}%`; }
                    for(let i=0; i<MEASURE_ROUNDS; i++) { status.innerText = `Measure JS: ${test.name}`; await new Promise(r => setTimeout(r, 10)); const t0 = performance.now(); test.js(); result.js_samples.push(performance.now() - t0); step++; prog.style.width = `${(step/totalSteps)*100}%`; }
                    result.js_mem = getMemory(false);

                    for(let i=0; i<WARMUP_ROUNDS; i++) { status.innerText = `Warmup Wasm: ${test.name}`; await new Promise(r => setTimeout(r, 10)); test.wasm(); step++; prog.style.width = `${(step/totalSteps)*100}%`; }
                    for(let i=0; i<MEASURE_ROUNDS; i++) { status.innerText = `Measure Wasm: ${test.name}`; await new Promise(r => setTimeout(r, 10)); const t0 = performance.now(); test.wasm(); result.wasm_samples.push(performance.now() - t0); step++; prog.style.width = `${(step/totalSteps)*100}%`; }
                    result.wasm_mem = getMemory(true);

                    result.js_stats = calculateStats(result.js_samples);
                    result.wasm_stats = calculateStats(result.wasm_samples);
                    result.speedup = result.js_stats.mean / result.wasm_stats.mean;

                    history.push(result);
                    localStorage.setItem('research_stats_data', JSON.stringify(history));
                }
                updateUI();
            } catch(e) { console.error(e); alert("Error: " + e.message); } 
            finally { overlay.style.display = 'none'; }
        };

        // --- IMPORT / EXPORT (FIXED) ---
        window.downloadCSV = function() {
            if(!history.length) return alert("No data to export");
            let csv = "Timestamp,Platform,Browser,Test,JS_Mean,JS_StdDev,Wasm_Mean,Wasm_StdDev,Speedup,JS_Mem,Wasm_Mem\n";
            history.forEach(r => {
                csv += `${r.timestamp},${r.platform},${r.browser},${r.test},${r.js_stats.mean.toFixed(2)},${r.js_stats.stdDev.toFixed(2)},${r.wasm_stats.mean.toFixed(2)},${r.wasm_stats.stdDev.toFixed(2)},${r.speedup.toFixed(2)},${r.js_mem},${r.wasm_mem}\n`;
            });
            const link = document.createElement("a");
            link.href = encodeURI("data:text/csv;charset=utf-8," + csv);
            link.download = "rigorous_benchmark_data.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        window.importCSV = function(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const lines = e.target.result.split('\n');
                    let count = 0;
                    // Skip header, parse rows
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if(!line) continue;
                        const cols = line.split(',');
                        if (cols.length < 11) continue;

                        const rec = {
                            timestamp: cols[0],
                            platform: cols[1],
                            browser: cols[2],
                            test: cols[3],
                            js_stats: { mean: parseFloat(cols[4]), stdDev: parseFloat(cols[5]), rsd: 0 }, // Reconstruct stats structure
                            wasm_stats: { mean: parseFloat(cols[6]), stdDev: parseFloat(cols[7]), rsd: 0 },
                            speedup: parseFloat(cols[8]),
                            js_mem: cols[9],
                            wasm_mem: cols[10]
                        };
                        
                        // Calc RSD for UI stability check
                        rec.js_stats.rsd = (rec.js_stats.stdDev / rec.js_stats.mean) * 100;
                        rec.wasm_stats.rsd = (rec.wasm_stats.stdDev / rec.wasm_stats.mean) * 100;

                        // Avoid duplicates
                        const exists = history.some(h => h.timestamp === rec.timestamp && h.test === rec.test && h.browser === rec.browser);
                        if (!exists) { history.push(rec); count++; }
                    }
                    if (count > 0) {
                        localStorage.setItem('research_stats_data', JSON.stringify(history));
                        updateUI();
                        alert(`Successfully merged ${count} records!`);
                    } else {
                        alert("No new records found (duplicates skipped).");
                    }
                } catch (err) { alert("Import Error: " + err.message); }
                input.value = ''; 
            };
            reader.readAsText(file);
        };

        window.clearData = function() {
            if(confirm("Clear all data?")) { history = []; localStorage.removeItem('research_stats_data'); updateUI(); }
        };

        // --- UI UPDATES ---
        function updateUI() {
            document.getElementById('total-samples').innerText = history.length;
            document.getElementById('last-run').innerText = history.length ? new Date().toLocaleTimeString() : "-";
            
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = history.slice().reverse().map(r => {
                const unstable = (r.js_stats.rsd > 5 || r.wasm_stats.rsd > 5);
                const stabilityTag = unstable 
                    ? `<span class="warn" title="High Variance">‚ö†Ô∏è Unstable</span>` 
                    : `<span style="color:var(--success-text)">‚úì Stable</span>`;
                const badgeClass = r.speedup > 1 ? 'speedup-good' : 'speedup-bad';

                return `<tr>
                    <td><b>${r.test}</b><br><span class="stat-detail">${r.browser} / ${r.platform}</span></td>
                    <td><div class="metric-val">${r.js_stats.mean.toFixed(2)} ms</div><span class="stat-detail">œÉ=${r.js_stats.stdDev.toFixed(2)}</span></td>
                    <td><div class="metric-val">${r.wasm_stats.mean.toFixed(2)} ms</div><span class="stat-detail">œÉ=${r.wasm_stats.stdDev.toFixed(2)}</span></td>
                    <td><span class="speedup-badge ${badgeClass}">${r.speedup.toFixed(2)}x</span></td>
                    <td><span class="stat-detail">JS: ${r.js_mem}<br>Wasm: ${r.wasm_mem} MB</span></td>
                    <td>${stabilityTag}</td>
                </tr>`;
            }).join('');
            updateCharts();
        }

        function updateCharts() {
            if(!history.length) return;
            const isDark = document.body.getAttribute('data-theme') === 'davan';
            const txtColor = isDark ? '#9ca3af' : '#6b7280';
            const gridColor = isDark ? '#374151' : '#e5e7eb';
            
            const labels = history.map(r => r.test.split(' ')[0]);
            
            if(charts.time) charts.time.destroy();
            charts.time = new Chart(document.getElementById('timeChart'), {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: 'JS Mean (ms)', data: history.map(r => r.js_stats.mean), borderColor: '#ef4444', tension: 0.3 },
                        { label: 'Wasm Mean (ms)', data: history.map(r => r.wasm_stats.mean), borderColor: '#10b981', tension: 0.3 }
                    ]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: txtColor } } },
                    scales: { 
                        y: { type: 'logarithmic', grid: { color: gridColor }, ticks: { color: txtColor } },
                        x: { grid: { display: false }, ticks: { color: txtColor } }
                    }
                }
            });

            if(charts.speed) charts.speed.destroy();
            charts.speed = new Chart(document.getElementById('speedupChart'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{ 
                        label: 'Speedup Factor', 
                        data: history.map(r => r.speedup), 
                        backgroundColor: history.map(r => r.speedup > 1 ? '#10b981' : '#ef4444'),
                        borderRadius: 4
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: txtColor } },
                        x: { grid: { display: false }, ticks: { color: txtColor } }
                    }
                }
            });
        }
    </script>
</body>
</html>